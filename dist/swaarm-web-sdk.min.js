window._SwaarmSdk={initialize:function(t,e,i=null,n=null,a=2,s=!1){if(null==t||!t.startsWith("http"))throw new Error("Invalid tracking url received: "+t);this.trackingUrl=t.replace(/\/$/,""),this.token=e,this.attributionCallback=n,this.flushFrequency=a,this.debug=s,this.events=[],this.queryParams=this._getQueryParams(),this.idfv=this._initializeIdfv(),this._getClickId((t=>{t?(this.clickId=t,localStorage.setItem("SWAARM_CLICK_ID",t),this.attributionData=this._readAttributionDataFromStorage(),this._checkAndFetchAttributionDataPeriodically(),this.initialized=!0,this._start(),i&&i()):console.error("Couldn't initialize SDK")}))},land:function(){if(!this.initialized)throw new Error("SDK not initialized");this._isFirstRun()&&this._addEvent(null,this.clickId),this._addEvent("__open"),this._sendEvents()},_start:function(){if(!this.initialized)throw new Error("SDK not initialized");this._sendEvents(),this.flushFrequency>0&&setInterval((()=>this._sendEvents()),1e3*this.flushFrequency)},_sendEvents:function(){if(!this.initialized)throw new Error("SDK not initialized");try{if(this._log("Checking for events to send: "+this.events.length),this.events.length>0){const t=this.events.slice(),e=JSON.stringify({time:(new Date).toISOString(),events:t});this._log("Sending events: "+e);const i=new XMLHttpRequest,n=this;i.open("POST",this.trackingUrl+"/sdk",!0),i.setRequestHeader("Content-Type","application/json"),i.setRequestHeader("Authorization",`Bearer ${this.token}`),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||201===i.status){n._log("Events sent successfully:",i.responseText);for(let e=n.events.length-1;e>=0;e--)t.includes(n.events[e])&&n.events.splice(e,1)}else console.error("Failed to send events:",i.status,i.responseText)},i.send(e)}}catch(t){console.error("Failed to send events",t)}},_readAttributionDataFromStorage:function(){const t=localStorage.getItem("SWAARM_ATTRIBUTION_DATA");if(t)return JSON.parse(t)},_getClickId:function(t){if(this.queryParams.swaarm_clickid)return void t(this.queryParams.swaarm_clickid);const e=localStorage.getItem("SWAARM_CLICK_ID");e?t(e):this._sendRequest(this.trackingUrl+"/utm_click?"+this._collectUtmData(),t,!1,(()=>t(void 0)))},_initializeIdfv:function(){const t=localStorage.getItem("SWAARM_SDK_ID");if(t)return t;const e=this._generateUUID();return localStorage.setItem("SWAARM_SDK_ID",e),e},_isFirstRun:function(){const t=null==localStorage.getItem("SWAARM_SDK_SEEN_FLAG");return t&&localStorage.setItem("SWAARM_SDK_SEEN_FLAG",!0),t},_generateUUID:function(){const t=[];for(let e=0;e<256;e++)t[e]=(e<16?"0":"")+e.toString(16);const e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0,a=4294967295*Math.random()|0;return t[255&e]+t[e>>8&255]+t[e>>16&255]+t[e>>24&255]+"-"+t[255&i]+t[i>>8&255]+"-"+t[i>>16&15|64]+t[i>>24&255]+"-"+t[63&n|128]+t[n>>8&255]+"-"+t[n>>16&255]+t[n>>24&255]+t[255&a]+t[a>>8&255]+t[a>>16&255]+t[a>>24&255]},_addEvent:function(t,e=null,i=0,n="",a=0,s=null){this.events.push({id:this._generateUUID(),typeId:t,aggregatedValue:i,customValue:n,revenue:a,currency:s,vendorId:this.idfv,clientTime:(new Date).toISOString(),clickId:e})},_getQueryParams:function(){const t=window.location.search.split("+").join(" "),e={},i=/[?&]?([^=]+)=([^&]*)/g;let n;for(;n=i.exec(t);)n.length>=3&&(e[decodeURIComponent(n[1])]=decodeURIComponent(n[2]));return e},_sendRequest:function(t,e,i=!1,n=null){this._log("Requesting "+t);const a=new XMLHttpRequest,s=this;a.addEventListener("load",(function(){s._log("Request to "+t+" sent successfully.")})),a.onreadystatechange=function(t){if(4===a.readyState)if(s._log("Response status "+a.status),200===a.status){s._log("Response body "+a.responseText);let t=a.responseText;!0===i&&(t=JSON.parse(a.responseText)),e&&e(t)}else n&&n()},a.open("GET",t),a.setRequestHeader("Authorization",`Bearer ${this.token}`),a.send()},_log:function(t){this.debug&&console.log("[SWAARM#SDK] "+t)},_collectUtmData:function(){const t=this._getQueryParams(),e=[];return t.utm_campaign&&e.push("campaign_id="+t.utm_campaign),t.utm_adset&&e.push("adset_id="+t.utm_adset),t.utm_ad&&e.push("ad_id="+t.utm_ad),t.utm_source&&e.push("site="+t.utm_source),t.utm_term&&e.push("term="+t.utm_term),t.gclid&&e.push("pub_click_id="+t.gclid),t.fbclid&&e.push("pub_click_id="+t.fbclid),t.ttclid&&e.push("pub_click_id="+t.ttclid),e.join("&")},_checkAndFetchAttributionDataPeriodically:function(){let t=1e3*this.flushFrequency;const e=this,i=()=>{e.attributionData&&e.attributionData.decision||(e.attributionTimer=setTimeout((()=>{e._fetchAttributionData(),e.attributionData&&e.attributionData.decision?(clearTimeout(e.attributionTimer),e.attributionTimer=null):(t=Math.round(1e3*Math.pow(t/1e3,1.5)),e._log(`Attribution data backoff interval: ${t} ms`),i())}),t))};i()},_fetchAttributionData:function(){try{const t=new URL(this.trackingUrl+"/attribution-data");t.searchParams.append("vendorId",this.idfv),this._log(`Fetching attribution data from ${t}`);const e=new XMLHttpRequest;e.open("GET",t,!0),e.setRequestHeader("Content-Type","application/json"),e.setRequestHeader("Authorization",`Bearer ${this.token}`);const i=this;e.onreadystatechange=()=>{if(4===e.readyState)if(200===e.status){const t=e.responseText;if(i._log(`Fetched attribution data from server: ${t}`),i.attributionData=JSON.parse(t),i.attributionData?.decision&&i.attributionCallback)try{i._log("Calling attribution callback"),i.attributionCallback(i.attributionData)}catch(t){console.error("Error in attribution callback:",t)}localStorage.setItem("SWAARM_ATTRIBUTION_DATA",t)}else console.error(`Failed to fetch attribution data: ${e.status}`)},e.send()}catch(t){console.error("Exception while fetching attribution data:",t)}},_associateUserId:function(t){const e=new URL(this.trackingUrl+"/associate-user");e.searchParams.append("idfv",this.idfv),e.searchParams.append("user_id",t),this._log(`Associating ${t} with ${this.idfv}`);const i=new XMLHttpRequest;i.open("GET",e,!0),i.setRequestHeader("Content-Type","application/json"),i.setRequestHeader("Authorization",`Bearer ${this.token}`),i.send()}},window.SwaarmSdk={initialize:function(t,e,i=null,n=null,a=2,s=!1){window._SwaarmSdk.initialize(t,e,i,n,a,s)},land:function(){window._SwaarmSdk.land()},getAttributionData:function(){return window._SwaarmSdk.getAttributionData()},event:function(t,e=0,i="",n=0,a=null){window._SwaarmSdk._addEvent(t,null,e,i,n,a)},associateUserId:function(t){window._SwaarmSdk._associateUserId(t)}};
